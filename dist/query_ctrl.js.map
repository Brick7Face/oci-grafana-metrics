{"version":3,"sources":["../src/query_ctrl.js"],"names":["QueryCtrl","aggregations","windows","_","OCIDatasourceQueryCtrl","$scope","$injector","$q","uiSegmentSrv","scope","target","region","compartment","resolution","namespace","window","metric","aggregation","tags","q","dimension","tagSegments","dimCache","removeTagFilterSegment","newSegment","fake","value","i","length","push","newCondition","obj","key","type","operator","newPlusButton","rawQuery","datasource","getNamespaces","then","namespaces","text","metricFindQuery","metrics","panelCtrl","refresh","getRegions","regs","catch","err","console","error","getCompartments","item","getDimensions","message","segment","index","when","mapToSegment","bind","handleQueryError","options","that","optSegments","map","v","dimensions","dims","values","split","unshift","splice","Math","max","newOperator","newFake","cssClass","rebuildTargetTagConditions","tagIndex","each","segment2","condition","templateUrl"],"mappings":"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","file":"query_ctrl.js","sourcesContent":["import { QueryCtrl } from 'app/plugins/sdk'\nimport './css/query-editor.css!'\nimport { aggregations, windows } from './constants'\nimport _ from 'lodash'\n\nexport class OCIDatasourceQueryCtrl extends QueryCtrl {\n  constructor ($scope, $injector, $q, uiSegmentSrv) {\n    super($scope, $injector)\n\n    this.scope = $scope\n    this.uiSegmentSrv = uiSegmentSrv\n    this.target.region = this.target.region || 'select region'\n    this.target.compartment = this.target.compartment || 'select compartment'\n    this.target.resolution = this.target.resolution || '1m'\n    this.target.namespace = this.target.namespace || 'select namespace'\n    this.target.window = this.target.window || '1m'\n    this.target.metric = this.target.metric || ''\n    this.target.aggregation = this.target.aggregation || 'mean()'\n    this.target.tags = this.target.tags || []\n    this.q = $q\n\n    this.target.dimension = this.target.dimension || ''\n\n    this.tagSegments = []\n    this.dimCache = {}\n    this.removeTagFilterSegment = uiSegmentSrv.newSegment({\n      fake: true,\n      value: '-- remove tag filter --'\n    })\n\n    for (let i = 0; i < this.target.tags.length; i++) {\n      if (i > 0) {\n        this.tagSegments.push(this.uiSegmentSrv.newCondition(','))\n      }\n      const obj = this.target.tags[i]\n      this.tagSegments.push(this.uiSegmentSrv.newSegment({\n        fake: false,\n        key: obj.key,\n        value: obj.key,\n        type: 'key'\n      }))\n      this.tagSegments.push(this.uiSegmentSrv.newSegment({\n        fake: false,\n        key: obj.operator,\n        type: 'operator',\n        value: obj.operator\n      }))\n      this.tagSegments.push(this.uiSegmentSrv.newSegment({\n        fake: false,\n        key: obj.value,\n        type: 'value',\n        value: obj.value\n      }))\n    }\n    this.tagSegments.push(this.uiSegmentSrv.newPlusButton())\n  }\n\n  toggleEditorMode () {\n    this.target.rawQuery = !this.target.rawQuery\n  }\n\n  getNamespaces () {\n    return this.datasource.getNamespaces(this.target)\n      .then((namespaces) => {\n        namespaces.push({ text: '$namespace', value: '$namespace' })\n        return namespaces\n      })\n  }\n\n  getMetrics () {\n    return this.datasource.metricFindQuery(this.target)\n      .then((metrics) => {\n        metrics.push({ text: '$metric', value: '$metric' })\n        return metrics\n      })\n  }\n\n  getAggregations () {\n    return aggregations\n  }\n\n  onChangeInternal () {\n    this.panelCtrl.refresh() // Asks the panel to refresh data.\n  }\n\n  getRegions () {\n    return this.datasource.getRegions()\n      .then((regs) => {\n        regs.push({ text: '$region', value: '$region' })\n        return regs\n      }).catch((err) => { console.error(err) })\n  }\n\n  getCompartments () {\n    return this.datasource.getCompartments()\n      .then((item) => {\n        item.push({ text: '$compartment', value: '$compartment' })\n        return item\n      })\n  }\n\n  getWindows () {\n    return windows\n  }\n\n  getDimensions () {\n    return this.datasource.getDimensions(this.target)\n  }\n\n  handleQueryError (err) {\n    this.error = err.message || 'Failed to issue metric query'\n    return []\n  }\n\n  getTagsOrValues (segment, index) {\n    if (segment.type === 'operator') {\n      return this.q.when([])\n    }\n\n    if (segment.type === 'key' || segment.type === 'plus-button') {\n      return this.getDimensions()\n        .then(this.mapToSegment.bind(this))\n        .catch(this.handleQueryError.bind(this))\n    }\n    const key = this.tagSegments[index - 2]\n    const options = this.dimCache[key.value]\n    const that = this\n    const optSegments = options.map(v => that.uiSegmentSrv.newSegment({\n      value: v\n    }))\n    return this.q.when(optSegments)\n  }\n\n  mapToSegment (dimensions) {\n    const dimCache = {}\n    const dims = dimensions.map((v) => {\n      const values = v.text.split('=')\n      const key = values[0]\n      const value = values[1]\n      if (!(key in dimCache)) {\n        dimCache[key] = []\n      }\n      dimCache[key].push(value)\n      return this.uiSegmentSrv.newSegment({\n        value: values[0]\n      })\n    })\n    dims.unshift(this.removeTagFilterSegment)\n    this.dimCache = dimCache\n    return dims\n  }\n\n  tagSegmentUpdated (segment, index) {\n    this.tagSegments[index] = segment\n\n    // handle remove tag condition\n    if (segment.value === this.removeTagFilterSegment.value) {\n      this.tagSegments.splice(index, 3)\n      if (this.tagSegments.length === 0) {\n        this.tagSegments.push(this.uiSegmentSrv.newPlusButton())\n      } else if (this.tagSegments.length > 2) {\n        this.tagSegments.splice(Math.max(index - 1, 0), 1)\n        if (this.tagSegments[this.tagSegments.length - 1].type !== 'plus-button') {\n          this.tagSegments.push(this.uiSegmentSrv.newPlusButton())\n        }\n      }\n    } else {\n      if (segment.type === 'plus-button') {\n        if (index > 2) {\n          this.tagSegments.splice(index, 0, this.uiSegmentSrv.newCondition(','))\n        }\n        this.tagSegments.push(this.uiSegmentSrv.newOperator('='))\n        this.tagSegments.push(this.uiSegmentSrv.newFake('select tag value', 'value', 'query-segment-value'))\n        segment.type = 'key'\n        segment.cssClass = 'query-segment-key'\n      }\n\n      if (index + 1 === this.tagSegments.length) {\n        this.tagSegments.push(this.uiSegmentSrv.newPlusButton())\n      }\n    }\n\n    this.rebuildTargetTagConditions()\n  }\n\n  rebuildTargetTagConditions () {\n    const tags = []\n    let tagIndex = 0\n\n    _.each(this.tagSegments, (segment2, index) => {\n      if (segment2.type === 'key') {\n        if (tags.length === 0) {\n          tags.push({})\n        }\n        tags[tagIndex].key = segment2.value\n      } else if (segment2.type === 'value') {\n        tags[tagIndex].value = segment2.value\n      } else if (segment2.type === 'condition') {\n        tags.push({ condition: segment2.value })\n        tagIndex += 1\n      } else if (segment2.type === 'operator') {\n        tags[tagIndex].operator = segment2.value\n      }\n    })\n\n    this.target.tags = tags\n    this.panelCtrl.refresh()\n  }\n}\n\nOCIDatasourceQueryCtrl.templateUrl = 'partials/query.editor.html'\n"]}